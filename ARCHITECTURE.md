# Bloom Health Architecture

## System Overview

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                    CLIENTS                                          │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│    ┌──────────────┐      ┌──────────────┐      ┌──────────────┐                    │
│    │   Browser    │      │   Mobile     │      │   Desktop    │                    │
│    │   (React)    │      │   (PWA)      │      │   (Electron) │                    │
│    └──────┬───────┘      └──────┬───────┘      └──────┬───────┘                    │
│           │                     │                     │                             │
│           └─────────────────────┼─────────────────────┘                             │
│                                 │                                                   │
│                                 ▼                                                   │
└─────────────────────────────────┼───────────────────────────────────────────────────┘
                                  │
                                  │ HTTPS
                                  │
┌─────────────────────────────────┼───────────────────────────────────────────────────┐
│                           EDGE NETWORK                                              │
├─────────────────────────────────┼───────────────────────────────────────────────────┤
│                                 │                                                   │
│    ┌────────────────────────────┴────────────────────────────────┐                  │
│    │                     Vercel Edge Network                     │                  │
│    │              (CDN, DDoS Protection, SSL/TLS)                │                  │
│    └────────────────────────────┬────────────────────────────────┘                  │
│                                 │                                                   │
│         ┌───────────────────────┼───────────────────────┐                           │
│         │                       │                       │                           │
│         ▼                       ▼                       ▼                           │
│  ┌──────────────┐       ┌──────────────┐       ┌──────────────┐                     │
│  │ bloomhealth  │       │qa.bloomhealth│       │  Preview     │                     │
│  │    .us       │       │    .us       │       │ Deployments  │                     │
│  │  (PROD)      │       │   (QA)       │       │  (PR-based)  │                     │
│  └──────────────┘       └──────────────┘       └──────────────┘                     │
│                                                                                     │
└─────────────────────────────────┬───────────────────────────────────────────────────┘
                                  │
                                  │
┌─────────────────────────────────┼───────────────────────────────────────────────────┐
│                         APPLICATION LAYER                                           │
├─────────────────────────────────┼───────────────────────────────────────────────────┤
│                                 │                                                   │
│    ┌────────────────────────────┴────────────────────────────────┐                  │
│    │                   Next.js 16 Application                    │                  │
│    │              (Vercel Serverless Functions)                  │                  │
│    └────────────────────────────┬────────────────────────────────┘                  │
│                                 │                                                   │
│    ┌────────────────────────────┴────────────────────────────────┐                  │
│    │                                                             │                  │
│    │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │                  │
│    │  │   Pages     │  │    API      │  │    Server           │  │                  │
│    │  │  (React 19) │  │   Routes    │  │    Components       │  │                  │
│    │  │             │  │   /api/*    │  │    (RSC)            │  │                  │
│    │  └─────────────┘  └─────────────┘  └─────────────────────┘  │                  │
│    │                                                             │                  │
│    └─────────────────────────────────────────────────────────────┘                  │
│                                                                                     │
│    ┌─────────────────────────────────────────────────────────────┐                  │
│    │                      API Endpoints                          │                  │
│    ├─────────────────────────────────────────────────────────────┤                  │
│    │  /api/auth/*        → Better Auth (SSO, 2FA, Sessions)      │                  │
│    │  /api/appointments  → Appointment Management                │                  │
│    │  /api/messages      → Messaging & Conversations             │                  │
│    │  /api/user/*        → User Profile & Settings               │                  │
│    │  /api/admin/*       → Admin Stats & Dashboard               │                  │
│    └─────────────────────────────────────────────────────────────┘                  │
│                                                                                     │
└─────────────────────────────────┬───────────────────────────────────────────────────┘
                                  │
                                  │
┌─────────────────────────────────┼───────────────────────────────────────────────────┐
│                         AUTHENTICATION                                              │
├─────────────────────────────────┼───────────────────────────────────────────────────┤
│                                 │                                                   │
│    ┌────────────────────────────┴────────────────────────────────┐                  │
│    │                      Better Auth                            │                  │
│    │           (Session Management & Authentication)             │                  │
│    └────────────────────────────┬────────────────────────────────┘                  │
│                                 │                                                   │
│         ┌───────────────────────┼───────────────────────┐                           │
│         │                       │                       │                           │
│         ▼                       ▼                       ▼                           │
│  ┌──────────────┐       ┌──────────────┐       ┌──────────────┐                     │
│  │    Email     │       │    Google    │       │    Zoom      │                     │
│  │  Password    │       │    OAuth     │       │    OAuth     │                     │
│  │  + 2FA/TOTP  │       │    SSO       │       │    SSO       │                     │
│  └──────────────┘       └──────────────┘       └──────────────┘                     │
│                                                                                     │
└─────────────────────────────────┬───────────────────────────────────────────────────┘
                                  │
                                  │
┌─────────────────────────────────┼───────────────────────────────────────────────────┐
│                           DATA LAYER                                                │
├─────────────────────────────────┼───────────────────────────────────────────────────┤
│                                 │                                                   │
│    ┌────────────────────────────┴────────────────────────────────┐                  │
│    │                      Prisma ORM                             │                  │
│    │              (Type-safe Database Access)                    │                  │
│    └────────────────────────────┬────────────────────────────────┘                  │
│                                 │                                                   │
│         ┌───────────────────────┴───────────────────────┐                           │
│         │                                               │                           │
│         ▼                                               ▼                           │
│  ┌──────────────────────┐                 ┌──────────────────────┐                  │
│  │   CockroachDB        │                 │   CockroachDB        │                  │
│  │   PRODUCTION         │                 │   QA/STAGING         │                  │
│  │                      │                 │                      │                  │
│  │   meek-wallaby       │                 │   exotic-cuscus      │                  │
│  │   GCP US-West2       │                 │   GCP US-West2       │                  │
│  └──────────────────────┘                 └──────────────────────┘                  │
│                                                                                     │
│  Database Schema:                                                                   │
│  ┌───────────────────────────────────────────────────────────────┐                  │
│  │  User ─┬─ Account ─ Session                                   │                  │
│  │        ├─ TwoFactor                                           │                  │
│  │        ├─ Appointment ─ AppointmentAttendee                   │                  │
│  │        ├─ Message ─ MessageAttachment                         │                  │
│  │        ├─ Conversation ─ ConversationMember                   │                  │
│  │        └─ FileAsset ─ FileShare                               │                  │
│  └───────────────────────────────────────────────────────────────┘                  │
│                                                                                     │
└─────────────────────────────────┬───────────────────────────────────────────────────┘
                                  │
                                  │
┌─────────────────────────────────┼───────────────────────────────────────────────────┐
│                         OBSERVABILITY                                               │
├─────────────────────────────────┼───────────────────────────────────────────────────┤
│                                 │                                                   │
│    ┌────────────────────────────┴────────────────────────────────┐                  │
│    │                     Grafana Cloud                           │                  │
│    │                  (opscvisuals.grafana.net)                  │                  │
│    └────────────────────────────┬────────────────────────────────┘                  │
│                                 │                                                   │
│         ┌───────────────────────┼───────────────────────┐                           │
│         │                       │                       │                           │
│         ▼                       ▼                       ▼                           │
│  ┌──────────────┐       ┌──────────────┐       ┌──────────────┐                     │
│  │  bloom-qa    │       │bloom-prod    │       │   Vercel     │                     │
│  │  Dashboard   │       │  Dashboard   │       │   Analytics  │                     │
│  └──────────────┘       └──────────────┘       └──────────────┘                     │
│                                                                                     │
│  Metrics & Logs:                                                                    │
│  • CockroachDB metrics (connections, queries, latency)                              │
│  • Vercel application logs & function invocations                                   │
│  • User signups & growth                                                            │
│  • Active sessions                                                                  │
│  • API response times                                                               │
│  • Error rates                                                                      │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘


## Caching Layer

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           CACHING (REDIS)                                           │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│    ┌─────────────────────────────────────────────────────────────┐                  │
│    │                     Upstash Redis                           │                  │
│    │              (Serverless Redis Database)                    │                  │
│    └─────────────────────────────────────────────────────────────┘                  │
│                                                                                     │
│  Use Cases:                                                                         │
│  • Session caching                                                                  │
│  • API response caching                                                             │
│  • Rate limiting                                                                    │
│  • Real-time data                                                                   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘


## Local Development

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                         LOCAL DEVELOPMENT                                           │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│    ┌─────────────────────────────────────────────────────────────┐                  │
│    │                    Docker Compose                           │                  │
│    │                                                             │                  │
│    │  ┌─────────────────────┐      ┌─────────────────────┐       │                  │
│    │  │                     │      │                     │       │                  │
│    │  │    Next.js App      │◄────►│   CockroachDB       │       │                  │
│    │  │    Port 3000        │      │   Port 26257        │       │                  │
│    │  │                     │      │   (Insecure Mode)   │       │                  │
│    │  └─────────────────────┘      └─────────────────────┘       │                  │
│    │                                        │                    │                  │
│    │                               ┌────────┴────────┐           │                  │
│    │                               │ cockroach-data  │           │                  │
│    │                               │    (Volume)     │           │                  │
│    │                               └─────────────────┘           │                  │
│    │                                                             │                  │
│    └─────────────────────────────────────────────────────────────┘                  │
│                                                                                     │
│    Alternative: npm run dev (with CockroachDB Cloud)                                │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘


## Deployment Flow

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          CI/CD PIPELINE                                             │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│    Developer                                                                        │
│        │                                                                            │
│        ▼                                                                            │
│    ┌──────────────┐                                                                 │
│    │  git push    │                                                                 │
│    │  to branch   │                                                                 │
│    └──────┬───────┘                                                                 │
│           │                                                                         │
│           ▼                                                                         │
│    ┌──────────────────────────────────────────────┐                                 │
│    │              GitHub Repository               │                                 │
│    │           opsc-io/bloom (private)            │                                 │
│    └──────────────────────┬───────────────────────┘                                 │
│                           │                                                         │
│           ┌───────────────┼───────────────┐                                         │
│           │               │               │                                         │
│           ▼               ▼               ▼                                         │
│    ┌────────────┐  ┌────────────┐  ┌────────────┐                                   │
│    │   main     │  │    qa      │  │  feature/* │                                   │
│    │  branch    │  │  branch    │  │  branches  │                                   │
│    └─────┬──────┘  └─────┬──────┘  └─────┬──────┘                                   │
│          │               │               │                                          │
│          ▼               ▼               ▼                                          │
│    ┌────────────┐  ┌────────────┐  ┌────────────┐                                   │
│    │ Production │  │    QA      │  │  Preview   │                                   │
│    │ bloomhealth│  │qa.bloom... │  │ *.vercel   │                                   │
│    │    .us     │  │    .us     │  │   .app     │                                   │
│    └────────────┘  └────────────┘  └────────────┘                                   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘


## Tech Stack Summary

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            TECH STACK                                               │
├─────────────────┬───────────────────────────────────────────────────────────────────┤
│  Frontend       │  Next.js 16, React 19, TailwindCSS 4, shadcn/ui, Recharts        │
├─────────────────┼───────────────────────────────────────────────────────────────────┤
│  Backend        │  Next.js API Routes, Server Components (RSC)                     │
├─────────────────┼───────────────────────────────────────────────────────────────────┤
│  Database       │  CockroachDB Cloud (Distributed SQL)                             │
├─────────────────┼───────────────────────────────────────────────────────────────────┤
│  ORM            │  Prisma 7 with CockroachDB adapter                               │
├─────────────────┼───────────────────────────────────────────────────────────────────┤
│  Auth           │  Better Auth (Email, Google OAuth, Zoom OAuth, 2FA/TOTP)         │
├─────────────────┼───────────────────────────────────────────────────────────────────┤
│  Hosting        │  Vercel (Edge Network, Serverless Functions)                     │
├─────────────────┼───────────────────────────────────────────────────────────────────┤
│  Observability  │  Grafana Cloud, Vercel Analytics                                 │
├─────────────────┼───────────────────────────────────────────────────────────────────┤
│  Email          │  Nodemailer (SMTP)                                               │
├─────────────────┼───────────────────────────────────────────────────────────────────┤
│  Video          │  Zoom SDK Integration                                            │
├─────────────────┼───────────────────────────────────────────────────────────────────┤
│  Container      │  Docker (multi-stage build, standalone output)                   │
└─────────────────┴───────────────────────────────────────────────────────────────────┘


## Security

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            SECURITY                                                 │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ✓ HTTPS/TLS everywhere (Vercel Edge)                                              │
│  ✓ Session-based authentication (httpOnly cookies)                                 │
│  ✓ Two-factor authentication (TOTP)                                                │
│  ✓ OAuth 2.0 with Google and Zoom                                                  │
│  ✓ Password hashing (bcrypt)                                                       │
│  ✓ CSRF protection (Better Auth)                                                   │
│  ✓ SQL injection prevention (Prisma ORM)                                           │
│  ✓ Environment variable secrets                                                    │
│  ✓ Database SSL connections (sslmode=verify-full)                                  │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## Environment Configuration

| Environment | Domain | Database | Grafana Dashboard |
|-------------|--------|----------|-------------------|
| Production | bloomhealth.us | meek-wallaby (CockroachDB) | bloom-production |
| QA/Staging | qa.bloomhealth.us | exotic-cuscus (CockroachDB) | bloom-qa |
| Local | localhost:3000 | Docker CockroachDB | N/A |

## Key User Flows

1. **Patient Flow**: Sign up → Complete profile → Connect with therapist → Schedule appointments → Video sessions
2. **Therapist Flow**: Sign up → Verify credentials → Accept patients → Manage schedule → Conduct sessions
3. **Admin Flow**: Login → View dashboard → Monitor metrics → Manage users
