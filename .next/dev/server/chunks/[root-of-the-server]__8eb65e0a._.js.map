{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 226, "column": 0}, "map": {"version":3,"sources":["file:///Users/varad/Projects/OPSC/src/db/entities/Role.ts"],"sourcesContent":["import { Entity, PrimaryGeneratedColumn, Column, OneToMany } from 'typeorm';\nimport { UserRole } from './UserRole';\n\n@Entity('roles')\nexport class Role {\n  @PrimaryGeneratedColumn()\n  role_id: number;\n\n  @Column({ length: 50, unique: true })\n  name: string;\n\n  @OneToMany(() => UserRole, userRole => userRole.role)\n  userRoles: UserRole[];\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;;;AAGO,MAAM;IAEX,QAAgB;IAGhB,KAAa;IAGb,UAAsB;AACxB;;;;;;;QALY,QAAQ;QAAI,QAAQ;;;;;8JAGb,+IAAQ,GAAE,WAAY,SAAS,IAAI","debugId":null}},
    {"offset": {"line": 265, "column": 0}, "map": {"version":3,"sources":["file:///Users/varad/Projects/OPSC/src/db/entities/UserRole.ts"],"sourcesContent":["import { Entity, PrimaryColumn, ManyToOne } from 'typeorm';\nimport { User } from './User';\nimport { Role } from './Role';\n\n@Entity('user_roles')\nexport class UserRole {\n  @PrimaryColumn('uuid')\n  user_id: string;\n\n  @PrimaryColumn()\n  role_id: number;\n\n  @ManyToOne(() => User, user => user.userRoles)\n  user: User;\n\n  @ManyToOne(() => Role, role => role.userRoles)\n  role: Role;\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;;;AAGO,MAAM;IAEX,QAAgB;IAGhB,QAAgB;IAGhB,KAAW;IAGX,KAAW;AACb;;;;;;;;;;8JALmB,uIAAI,GAAE,OAAQ,KAAK,SAAS;;;;8JAG5B,uIAAI,GAAE,OAAQ,KAAK,SAAS","debugId":null}},
    {"offset": {"line": 308, "column": 0}, "map": {"version":3,"sources":["file:///Users/varad/Projects/OPSC/src/db/entities/User.ts"],"sourcesContent":["import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, UpdateDateColumn, OneToMany } from 'typeorm';\nimport { UserRole } from './UserRole';\n\n@Entity('users')\nexport class User {\n  @PrimaryGeneratedColumn('uuid')\n  user_id: string;\n\n  @Column({ type: 'citext', unique: true })\n  email: string;\n\n  // Store the password hash for traditional email/password auth.\n  // Use snake_case column name `password_hash` to match common DB conventions.\n  @Column({ name: 'password_hash', nullable: true })\n  password_hash: string;\n\n  @Column({ type: 'jsonb', nullable: true })\n  passkey_credential: any;\n\n  @Column({ nullable: true })\n  mfa_secret: string;\n\n  @CreateDateColumn()\n  created_at: Date;\n\n  @Column({ type: 'timestamptz', nullable: true })\n  last_login: Date;\n\n  @Column({ default: true })\n  is_active: boolean;\n\n  @OneToMany(() => UserRole, userRole => userRole.user)\n  userRoles: UserRole[];\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;;;AAGO,MAAM;IAEX,QAAgB;IAGhB,MAAc;IAEd,+DAA+D;IAC/D,6EAA6E;IAE7E,cAAsB;IAGtB,mBAAwB;IAGxB,WAAmB;IAGnB,WAAiB;IAGjB,WAAiB;IAGjB,UAAmB;IAGnB,UAAsB;AACxB;;;;;;;QAzBY,MAAM;QAAU,QAAQ;;;;;;QAKxB,MAAM;QAAiB,UAAU;;;;;;QAGjC,MAAM;QAAS,UAAU;;;;;;QAGzB,UAAU;;;;;;;;;;QAMV,MAAM;QAAe,UAAU;;;;;;QAG/B,SAAS;;;;;8JAGF,+IAAQ,GAAE,WAAY,SAAS,IAAI","debugId":null}},
    {"offset": {"line": 392, "column": 0}, "map": {"version":3,"sources":["file:///Users/varad/Projects/OPSC/src/db/entities/Provider.ts"],"sourcesContent":["import { Entity, PrimaryColumn, Column, OneToOne, JoinColumn } from 'typeorm';\nimport { User } from './User';\n\n@Entity('providers')\nexport class Provider {\n  @PrimaryColumn('uuid')\n  user_id: string;\n\n  @Column({ length: 10, unique: true, nullable: true })\n  npi_number: string;\n\n  @Column({ \n    type: 'varchar',\n    length: 20,\n    default: 'pending'\n  })\n  license_verification_status: string;\n\n  @Column({ type: 'uuid', nullable: true })\n  credentialing_package_id: string;\n\n  @OneToOne(() => User)\n  @JoinColumn({ name: 'user_id' })\n  user: User;\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;;;AAGO,MAAM;IAEX,QAAgB;IAGhB,WAAmB;IAOnB,4BAAoC;IAGpC,yBAAiC;IAIjC,KAAW;AACb;;;;;;;QAhBY,QAAQ;QAAI,QAAQ;QAAM,UAAU;;;;;;QAI5C,MAAM;QACN,QAAQ;QACR,SAAS;;;;;;QAID,MAAM;QAAQ,UAAU;;;;;6JAGlB,uIAAI;;QACN,MAAM","debugId":null}},
    {"offset": {"line": 452, "column": 0}, "map": {"version":3,"sources":["file:///Users/varad/Projects/OPSC/src/db/entities/Client.ts"],"sourcesContent":["import { Entity, PrimaryColumn, Column, OneToOne, ManyToOne, JoinColumn } from 'typeorm';\nimport { User } from './User';\nimport { Provider } from './Provider';\n\n@Entity('clients')\nexport class Client {\n  @PrimaryColumn('uuid')\n  user_id: string;\n\n  @Column('uuid', { nullable: true })\n  primary_therapist: string;\n\n  @Column({ length: 50, nullable: true })\n  insurance_id: string;\n\n  @Column({ type: 'jsonb', nullable: true })\n  emergency_contact: any;\n\n  @OneToOne(() => User)\n  @JoinColumn({ name: 'user_id' })\n  user: User;\n\n  @ManyToOne(() => Provider)\n  @JoinColumn({ name: 'primary_therapist' })\n  provider: Provider;\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;;;AAGO,MAAM;IAEX,QAAgB;IAGhB,kBAA0B;IAG1B,aAAqB;IAGrB,kBAAuB;IAIvB,KAAW;IAIX,SAAmB;AACrB;;;;;;;QAhBoB,UAAU;;;;;;QAGlB,QAAQ;QAAI,UAAU;;;;;;QAGtB,MAAM;QAAS,UAAU;;;;;6JAGnB,uIAAI;;QACN,MAAM;;;;;8JAGH,+IAAQ;;QACX,MAAM","debugId":null}},
    {"offset": {"line": 519, "column": 0}, "map": {"version":3,"sources":["file:///Users/varad/Projects/OPSC/src/db/entities/UserProvider.ts"],"sourcesContent":["import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, ManyToOne, JoinColumn } from 'typeorm';\nimport { User } from './User';\n\n@Entity('user_providers')\nexport class UserProvider {\n  @PrimaryGeneratedColumn('uuid')\n  id: string;\n\n  @Column('uuid')\n  user_id: string;\n\n  @Column({ length: 50 })\n  provider: string;\n\n  @Column({ length: 200 })\n  provider_user_id: string;\n\n  @Column({ type: 'jsonb', nullable: true })\n  provider_data: any;\n\n  @CreateDateColumn()\n  created_at: Date;\n\n  @ManyToOne(() => User)\n  @JoinColumn({ name: 'user_id' })\n  user: User;\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;;;AAGO,MAAM;IAEX,GAAW;IAGX,QAAgB;IAGhB,SAAiB;IAGjB,iBAAyB;IAGzB,cAAmB;IAGnB,WAAiB;IAIjB,KAAW;AACb;;;;;;;;;;;QAfY,QAAQ;;;;;;QAGR,QAAQ;;;;;;QAGR,MAAM;QAAS,UAAU;;;;;;;;;8JAMlB,uIAAI;;QACP,MAAM","debugId":null}},
    {"offset": {"line": 585, "column": 0}, "map": {"version":3,"sources":["file:///Users/varad/Projects/OPSC/src/migrations/001AddPasswordHash.ts"],"sourcesContent":["import { MigrationInterface, QueryRunner } from \"typeorm\";\n\nexport class AddPasswordHash001 implements MigrationInterface {\n  name = 'AddPasswordHash001';\n\n  public async up(queryRunner: QueryRunner): Promise<void> {\n    // Add a nullable password_hash column compatible with Postgres/CockroachDB\n    await queryRunner.query(`ALTER TABLE IF EXISTS users ADD COLUMN IF NOT EXISTS password_hash VARCHAR;`);\n  }\n\n  public async down(queryRunner: QueryRunner): Promise<void> {\n    await queryRunner.query(`ALTER TABLE IF EXISTS users DROP COLUMN IF EXISTS password_hash;`);\n  }\n}\n\nexport default AddPasswordHash001;\n"],"names":[],"mappings":";;;;;;AAEO,MAAM;IACX,OAAO,qBAAqB;IAE5B,MAAa,GAAG,WAAwB,EAAiB;QACvD,2EAA2E;QAC3E,MAAM,YAAY,KAAK,CAAC,CAAC,2EAA2E,CAAC;IACvG;IAEA,MAAa,KAAK,WAAwB,EAAiB;QACzD,MAAM,YAAY,KAAK,CAAC,CAAC,gEAAgE,CAAC;IAC5F;AACF;uCAEe","debugId":null}},
    {"offset": {"line": 606, "column": 0}, "map": {"version":3,"sources":["file:///Users/varad/Projects/OPSC/src/migrations/002ConvertEmailToVarchar.ts"],"sourcesContent":["import { MigrationInterface, QueryRunner } from \"typeorm\";\n\nexport class ConvertEmailToVarchar002 implements MigrationInterface {\n  name = 'ConvertEmailToVarchar002';\n\n  public async up(queryRunner: QueryRunner): Promise<void> {\n    // Create a temporary column and populate with lower(email)\n    await queryRunner.query(`ALTER TABLE IF EXISTS users ADD COLUMN IF NOT EXISTS email_new VARCHAR;`);\n    await queryRunner.query(`UPDATE users SET email_new = lower(CAST(email AS text));`);\n\n    // Drop old column and rename\n    await queryRunner.query(`ALTER TABLE users DROP COLUMN IF EXISTS email;`);\n    await queryRunner.query(`ALTER TABLE users RENAME COLUMN email_new TO email;`);\n\n    // Create a case-insensitive unique index on lower(email)\n    // Use IF NOT EXISTS for idempotency\n    await queryRunner.query(`CREATE UNIQUE INDEX IF NOT EXISTS uniq_users_email_lower ON users ((lower(email)));`);\n  }\n\n  public async down(queryRunner: QueryRunner): Promise<void> {\n    // Attempt to restore previous state is non-trivial; as a safe rollback, drop the index\n    await queryRunner.query(`DROP INDEX IF EXISTS uniq_users_email_lower;`);\n  }\n}\n\nexport default ConvertEmailToVarchar002;\n"],"names":[],"mappings":";;;;;;AAEO,MAAM;IACX,OAAO,2BAA2B;IAElC,MAAa,GAAG,WAAwB,EAAiB;QACvD,2DAA2D;QAC3D,MAAM,YAAY,KAAK,CAAC,CAAC,uEAAuE,CAAC;QACjG,MAAM,YAAY,KAAK,CAAC,CAAC,wDAAwD,CAAC;QAElF,6BAA6B;QAC7B,MAAM,YAAY,KAAK,CAAC,CAAC,8CAA8C,CAAC;QACxE,MAAM,YAAY,KAAK,CAAC,CAAC,mDAAmD,CAAC;QAE7E,yDAAyD;QACzD,oCAAoC;QACpC,MAAM,YAAY,KAAK,CAAC,CAAC,mFAAmF,CAAC;IAC/G;IAEA,MAAa,KAAK,WAAwB,EAAiB;QACzD,uFAAuF;QACvF,MAAM,YAAY,KAAK,CAAC,CAAC,4CAA4C,CAAC;IACxE;AACF;uCAEe","debugId":null}},
    {"offset": {"line": 635, "column": 0}, "map": {"version":3,"sources":["file:///Users/varad/Projects/OPSC/src/migrations/003CreateUserProviders.ts"],"sourcesContent":["import { MigrationInterface, QueryRunner } from \"typeorm\";\n\nexport class CreateUserProviders003 implements MigrationInterface {\n  name = 'CreateUserProviders003';\n\n  public async up(queryRunner: QueryRunner): Promise<void> {\n    // Create table user_providers compatible with Postgres/CockroachDB\n    await queryRunner.query(`\n      CREATE TABLE IF NOT EXISTS user_providers (\n        id UUID PRIMARY KEY,\n        user_id UUID NOT NULL,\n        provider VARCHAR(50) NOT NULL,\n        provider_user_id VARCHAR(200) NOT NULL,\n        provider_data JSONB,\n        created_at TIMESTAMPTZ DEFAULT now(),\n        CONSTRAINT fk_user FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE\n      );\n    `);\n\n    await queryRunner.query(`CREATE UNIQUE INDEX IF NOT EXISTS uniq_user_providers_provider_user ON user_providers (provider, provider_user_id);`);\n  }\n\n  public async down(queryRunner: QueryRunner): Promise<void> {\n    await queryRunner.query(`DROP INDEX IF EXISTS uniq_user_providers_provider_user;`);\n    await queryRunner.query(`DROP TABLE IF EXISTS user_providers;`);\n  }\n}\n\nexport default CreateUserProviders003;\n"],"names":[],"mappings":";;;;;;AAEO,MAAM;IACX,OAAO,yBAAyB;IAEhC,MAAa,GAAG,WAAwB,EAAiB;QACvD,mEAAmE;QACnE,MAAM,YAAY,KAAK,CAAC,CAAC;;;;;;;;;;IAUzB,CAAC;QAED,MAAM,YAAY,KAAK,CAAC,CAAC,mHAAmH,CAAC;IAC/I;IAEA,MAAa,KAAK,WAAwB,EAAiB;QACzD,MAAM,YAAY,KAAK,CAAC,CAAC,uDAAuD,CAAC;QACjF,MAAM,YAAY,KAAK,CAAC,CAAC,oCAAoC,CAAC;IAChE;AACF;uCAEe","debugId":null}},
    {"offset": {"line": 668, "column": 0}, "map": {"version":3,"sources":["file:///Users/varad/Projects/OPSC/src/config.ts"],"sourcesContent":["// Centralized configuration values. Keep minimal here and read from environment\nexport const RP_ID = process.env.RP_ID || 'localhost';\nexport const ORIGIN = process.env.ORIGIN || 'http://localhost:3000';\n\n// Small helper to expose whether we're in development\nexport const IS_DEV = (process.env.NODE_ENV || 'development') === 'development';\n"],"names":[],"mappings":"AAAA,gFAAgF;;;;;;;;;AACzE,MAAM,QAAQ,QAAQ,GAAG,CAAC,KAAK,IAAI;AACnC,MAAM,SAAS,QAAQ,GAAG,CAAC,MAAM,IAAI;AAGrC,MAAM,SAAS,CAAC,mDAAwB,aAAa,MAAM","debugId":null}},
    {"offset": {"line": 684, "column": 0}, "map": {"version":3,"sources":["file:///Users/varad/Projects/OPSC/src/db/data-source.ts"],"sourcesContent":["import { DataSource } from \"typeorm\";\nimport { User } from \"./entities/User\";\nimport { Role } from \"./entities/Role\";\nimport { UserRole } from \"./entities/UserRole\";\nimport { Provider } from \"./entities/Provider\";\nimport { Client } from \"./entities/Client\";\nimport { UserProvider } from \"./entities/UserProvider\";\nimport AddPasswordHash001 from \"../migrations/001AddPasswordHash\";\nimport ConvertEmailToVarchar002 from \"../migrations/002ConvertEmailToVarchar\";\nimport CreateUserProviders003 from \"../migrations/003CreateUserProviders\";\nimport { IS_DEV } from \"../config\";\n\nconst DB_HOST = process.env.DB_HOST || 'localhost';\nconst DB_PORT = parseInt(process.env.DB_PORT || '5432', 10);\nconst DB_USER = process.env.DB_USER || 'postgres';\nconst DB_PASS = process.env.DB_PASS || 'postgres';\nconst DB_NAME = process.env.DB_NAME || 'therapy_platform';\n\nexport const AppDataSource = new DataSource({\n    type: \"postgres\",\n    host: DB_HOST,\n    port: DB_PORT,\n    username: DB_USER,\n    password: DB_PASS,\n    database: DB_NAME,\n    // Use synchronize only in development. Use migrations for production.\n    synchronize: IS_DEV,\n    logging: IS_DEV,\n    entities: [User, Role, UserRole, Provider, Client, UserProvider],\n    subscribers: [],\n    migrations: [AddPasswordHash001, ConvertEmailToVarchar002, CreateUserProviders003],\n});\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AAEA,MAAM,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI;AACvC,MAAM,UAAU,SAAS,QAAQ,GAAG,CAAC,OAAO,IAAI,QAAQ;AACxD,MAAM,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI;AACvC,MAAM,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI;AACvC,MAAM,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI;AAEhC,MAAM,gBAAgB,IAAI,iJAAU,CAAC;IACxC,MAAM;IACN,MAAM;IACN,MAAM;IACN,UAAU;IACV,UAAU;IACV,UAAU;IACV,sEAAsE;IACtE,aAAa,yHAAM;IACnB,SAAS,yHAAM;IACf,UAAU;QAAC,uIAAI;QAAE,uIAAI;QAAE,+IAAQ;QAAE,+IAAQ;QAAE,2IAAM;QAAE,uJAAY;KAAC;IAChE,aAAa,EAAE;IACf,YAAY;QAAC,oJAAkB;QAAE,0JAAwB;QAAE,wJAAsB;KAAC;AACtF","debugId":null}},
    {"offset": {"line": 744, "column": 0}, "map": {"version":3,"sources":["file:///Users/varad/Projects/OPSC/src/services/userService.ts"],"sourcesContent":["/**\n * Small user service helpers to find users and update credentials.\n */\nimport { AppDataSource } from '../db/data-source';\nimport { User } from '../db/entities/User';\n\nexport async function findUserByEmail(email: string) {\n  if (!AppDataSource.isInitialized) await AppDataSource.initialize();\n  const repo = AppDataSource.getRepository(User);\n  return repo.findOneBy({ email });\n}\n\nexport async function findUserById(userId: string) {\n  if (!AppDataSource.isInitialized) await AppDataSource.initialize();\n  const repo = AppDataSource.getRepository(User);\n  return repo.findOneBy({ user_id: userId });\n}\n\nexport default { findUserByEmail, findUserById };\n"],"names":[],"mappings":"AAAA;;CAEC;;;;;;;;AACD;AACA;;;AAEO,eAAe,gBAAgB,KAAa;IACjD,IAAI,CAAC,8IAAa,CAAC,aAAa,EAAE,MAAM,8IAAa,CAAC,UAAU;IAChE,MAAM,OAAO,8IAAa,CAAC,aAAa,CAAC,uIAAI;IAC7C,OAAO,KAAK,SAAS,CAAC;QAAE;IAAM;AAChC;AAEO,eAAe,aAAa,MAAc;IAC/C,IAAI,CAAC,8IAAa,CAAC,aAAa,EAAE,MAAM,8IAAa,CAAC,UAAU;IAChE,MAAM,OAAO,8IAAa,CAAC,aAAa,CAAC,uIAAI;IAC7C,OAAO,KAAK,SAAS,CAAC;QAAE,SAAS;IAAO;AAC1C;uCAEe;IAAE;IAAiB;AAAa","debugId":null}},
    {"offset": {"line": 786, "column": 0}, "map": {"version":3,"sources":["file:///Users/varad/Projects/OPSC/src/lib/jwt.ts"],"sourcesContent":["/**\n * Small JWT helper using jsonwebtoken. Exposes sign and verify helpers.\n */\nimport jwt from 'jsonwebtoken';\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'dev-secret-change-me';\nconst JWT_EXPIRES_IN = process.env.JWT_EXPIRES_IN || '7d';\n\nexport function signJwt(payload: object | string) {\n\tif (!JWT_SECRET) throw new Error('JWT secret is not configured');\n\treturn jwt.sign(payload as any, JWT_SECRET as any, { expiresIn: JWT_EXPIRES_IN } as any);\n}\n\nexport function verifyJwt<T = any>(token: string): T | null {\n\ttry {\n\t\treturn jwt.verify(token, JWT_SECRET as any) as T;\n\t} catch (err) {\n\t\treturn null;\n\t}\n}\n\nexport default { signJwt, verifyJwt };\n"],"names":[],"mappings":"AAAA;;CAEC;;;;;;;;AACD;;AAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAC7C,MAAM,iBAAiB,QAAQ,GAAG,CAAC,cAAc,IAAI;AAE9C,SAAS,QAAQ,OAAwB;IAC/C;;IACA,OAAO,kJAAG,CAAC,IAAI,CAAC,SAAgB,YAAmB;QAAE,WAAW;IAAe;AAChF;AAEO,SAAS,UAAmB,KAAa;IAC/C,IAAI;QACH,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAC1B,EAAE,OAAO,KAAK;QACb,OAAO;IACR;AACD;uCAEe;IAAE;IAAS;AAAU","debugId":null}},
    {"offset": {"line": 822, "column": 0}, "map": {"version":3,"sources":["file:///Users/varad/Projects/OPSC/src/services/authService.ts"],"sourcesContent":["/**\n * Authentication service responsible for user creation and login.\n * - Supports roles: 'provider', 'client', 'admin'\n * - Uses bcrypt for password hashing and jsonwebtoken for tokens.\n *\n * The exported functions are intentionally small and well-documented to\n * facilitate unit testing (they avoid tight coupling to global AppDataSource\n * where possible).\n */\nimport bcrypt from 'bcrypt';\nimport { signJwt } from '../lib/jwt';\nimport { AppDataSource } from '../db/data-source';\nimport { User } from '../db/entities/User';\nimport { Role } from '../db/entities/Role';\nimport { UserRole } from '../db/entities/UserRole';\n\nexport type SignupPayload = {\n  email: string;\n  password?: string; // optional for passkey-only flows\n  accountType: 'provider' | 'client' | 'admin';\n};\n\n/** Create a user and assign role. Returns the created user (without password). */\nexport async function signup(payload: SignupPayload) {\n  const { email, password, accountType } = payload;\n\n  // Initialize data source lazily if needed\n  if (!AppDataSource.isInitialized) await AppDataSource.initialize();\n\n  const userRepo = AppDataSource.getRepository(User);\n  const roleRepo = AppDataSource.getRepository(Role);\n  const userRoleRepo = AppDataSource.getRepository(UserRole);\n\n  const existing = await userRepo.findOneBy({ email });\n  if (existing) throw new Error('Email already registered');\n\n  const user = new User();\n  user.email = email;\n  if (password) {\n    const salt = await bcrypt.genSalt(10);\n    user.password_hash = await bcrypt.hash(password, salt);\n  }\n  user.is_active = true;\n  await userRepo.save(user);\n\n  // Find or create role\n  let role = await roleRepo.findOneBy({ name: accountType });\n  if (!role) {\n    role = new Role();\n    role.name = accountType;\n    await roleRepo.save(role);\n  }\n\n  const userRole = new UserRole();\n  userRole.user_id = user.user_id;\n  userRole.role_id = role.role_id;\n  await userRoleRepo.save(userRole);\n\n  // For security, don't return passwordHash\n  const out = { ...user } as any;\n  delete out.passwordHash;\n  return out as User;\n}\n\n/** Verify user credentials and return a JWT on success. */\nexport async function login(email: string, password: string) {\n  if (!AppDataSource.isInitialized) await AppDataSource.initialize();\n  const userRepo = AppDataSource.getRepository(User);\n  const user = await userRepo.findOneBy({ email });\n  if (!user) throw new Error('Invalid credentials');\n\n  // Passwords are optional if passkey-only auth is used; require a hash for password login\n  const passwordHash = (user as any).password_hash ?? (user as any).passwordHash;\n  if (!passwordHash) throw new Error('Password login not available for this account');\n\n  const ok = await bcrypt.compare(password, passwordHash as string);\n  if (!ok) throw new Error('Invalid credentials');\n\n  // Issue JWT with minimal claims\n  const token = signJwt({ sub: user.user_id, email: user.email });\n  return { token, user };\n}\n\nexport default { signup, login };\n"],"names":[],"mappings":"AAAA;;;;;;;;CAQC;;;;;;;;AACD;AACA;AACA;AACA;AACA;AACA;;;;;;;AASO,eAAe,OAAO,OAAsB;IACjD,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,WAAW,EAAE,GAAG;IAEzC,0CAA0C;IAC1C,IAAI,CAAC,8IAAa,CAAC,aAAa,EAAE,MAAM,8IAAa,CAAC,UAAU;IAEhE,MAAM,WAAW,8IAAa,CAAC,aAAa,CAAC,uIAAI;IACjD,MAAM,WAAW,8IAAa,CAAC,aAAa,CAAC,uIAAI;IACjD,MAAM,eAAe,8IAAa,CAAC,aAAa,CAAC,+IAAQ;IAEzD,MAAM,WAAW,MAAM,SAAS,SAAS,CAAC;QAAE;IAAM;IAClD,IAAI,UAAU,MAAM,IAAI,MAAM;IAE9B,MAAM,OAAO,IAAI,uIAAI;IACrB,KAAK,KAAK,GAAG;IACb,IAAI,UAAU;QACZ,MAAM,OAAO,MAAM,gHAAM,CAAC,OAAO,CAAC;QAClC,KAAK,aAAa,GAAG,MAAM,gHAAM,CAAC,IAAI,CAAC,UAAU;IACnD;IACA,KAAK,SAAS,GAAG;IACjB,MAAM,SAAS,IAAI,CAAC;IAEpB,sBAAsB;IACtB,IAAI,OAAO,MAAM,SAAS,SAAS,CAAC;QAAE,MAAM;IAAY;IACxD,IAAI,CAAC,MAAM;QACT,OAAO,IAAI,uIAAI;QACf,KAAK,IAAI,GAAG;QACZ,MAAM,SAAS,IAAI,CAAC;IACtB;IAEA,MAAM,WAAW,IAAI,+IAAQ;IAC7B,SAAS,OAAO,GAAG,KAAK,OAAO;IAC/B,SAAS,OAAO,GAAG,KAAK,OAAO;IAC/B,MAAM,aAAa,IAAI,CAAC;IAExB,0CAA0C;IAC1C,MAAM,MAAM;QAAE,GAAG,IAAI;IAAC;IACtB,OAAO,IAAI,YAAY;IACvB,OAAO;AACT;AAGO,eAAe,MAAM,KAAa,EAAE,QAAgB;IACzD,IAAI,CAAC,8IAAa,CAAC,aAAa,EAAE,MAAM,8IAAa,CAAC,UAAU;IAChE,MAAM,WAAW,8IAAa,CAAC,aAAa,CAAC,uIAAI;IACjD,MAAM,OAAO,MAAM,SAAS,SAAS,CAAC;QAAE;IAAM;IAC9C,IAAI,CAAC,MAAM,MAAM,IAAI,MAAM;IAE3B,yFAAyF;IACzF,MAAM,eAAe,AAAC,KAAa,aAAa,IAAI,AAAC,KAAa,YAAY;IAC9E,IAAI,CAAC,cAAc,MAAM,IAAI,MAAM;IAEnC,MAAM,KAAK,MAAM,gHAAM,CAAC,OAAO,CAAC,UAAU;IAC1C,IAAI,CAAC,IAAI,MAAM,IAAI,MAAM;IAEzB,gCAAgC;IAChC,MAAM,QAAQ,IAAA,8HAAO,EAAC;QAAE,KAAK,KAAK,OAAO;QAAE,OAAO,KAAK,KAAK;IAAC;IAC7D,OAAO;QAAE;QAAO;IAAK;AACvB;uCAEe;IAAE;IAAQ;AAAM","debugId":null}},
    {"offset": {"line": 919, "column": 0}, "map": {"version":3,"sources":["file:///Users/varad/Projects/OPSC/src/services/providerService.ts"],"sourcesContent":["/**\n * Provider service: manages OAuth provider link rows (user_providers table).\n */\nimport { AppDataSource } from '../db/data-source';\nimport { UserProvider } from '../db/entities/UserProvider';\n\nexport async function linkProvider(userId: string, provider: string, providerUserId: string, providerData: any) {\n  if (!AppDataSource.isInitialized) await AppDataSource.initialize();\n  const repo = AppDataSource.getRepository(UserProvider);\n\n  // Try to find an existing link\n  let existing = await repo.findOneBy({ provider, provider_user_id: providerUserId });\n  if (existing) {\n    // If it exists but is attached to a different user, re-attach or throw depending on policy.\n    if (existing.user_id !== userId) {\n      existing.user_id = userId;\n      existing.provider_data = providerData;\n      await repo.save(existing);\n    }\n    return existing;\n  }\n\n  const link = new UserProvider();\n  link.user_id = userId;\n  link.provider = provider;\n  link.provider_user_id = providerUserId;\n  link.provider_data = providerData;\n  return repo.save(link);\n}\n\nexport default { linkProvider };\n\nexport async function listProviders(userId: string) {\n  if (!AppDataSource.isInitialized) await AppDataSource.initialize();\n  const repo = AppDataSource.getRepository(UserProvider);\n  return repo.find({ where: { user_id: userId }, order: { created_at: 'DESC' } });\n}\n\nexport async function unlinkProvider(id: string) {\n  if (!AppDataSource.isInitialized) await AppDataSource.initialize();\n  const repo = AppDataSource.getRepository(UserProvider);\n  const rec = await repo.findOneBy({ id });\n  if (!rec) throw new Error('Provider link not found');\n  await repo.remove(rec);\n  return true;\n}\n"],"names":[],"mappings":"AAAA;;CAEC;;;;;;;;;;AACD;AACA;;;AAEO,eAAe,aAAa,MAAc,EAAE,QAAgB,EAAE,cAAsB,EAAE,YAAiB;IAC5G,IAAI,CAAC,8IAAa,CAAC,aAAa,EAAE,MAAM,8IAAa,CAAC,UAAU;IAChE,MAAM,OAAO,8IAAa,CAAC,aAAa,CAAC,uJAAY;IAErD,+BAA+B;IAC/B,IAAI,WAAW,MAAM,KAAK,SAAS,CAAC;QAAE;QAAU,kBAAkB;IAAe;IACjF,IAAI,UAAU;QACZ,4FAA4F;QAC5F,IAAI,SAAS,OAAO,KAAK,QAAQ;YAC/B,SAAS,OAAO,GAAG;YACnB,SAAS,aAAa,GAAG;YACzB,MAAM,KAAK,IAAI,CAAC;QAClB;QACA,OAAO;IACT;IAEA,MAAM,OAAO,IAAI,uJAAY;IAC7B,KAAK,OAAO,GAAG;IACf,KAAK,QAAQ,GAAG;IAChB,KAAK,gBAAgB,GAAG;IACxB,KAAK,aAAa,GAAG;IACrB,OAAO,KAAK,IAAI,CAAC;AACnB;uCAEe;IAAE;AAAa;AAEvB,eAAe,cAAc,MAAc;IAChD,IAAI,CAAC,8IAAa,CAAC,aAAa,EAAE,MAAM,8IAAa,CAAC,UAAU;IAChE,MAAM,OAAO,8IAAa,CAAC,aAAa,CAAC,uJAAY;IACrD,OAAO,KAAK,IAAI,CAAC;QAAE,OAAO;YAAE,SAAS;QAAO;QAAG,OAAO;YAAE,YAAY;QAAO;IAAE;AAC/E;AAEO,eAAe,eAAe,EAAU;IAC7C,IAAI,CAAC,8IAAa,CAAC,aAAa,EAAE,MAAM,8IAAa,CAAC,UAAU;IAChE,MAAM,OAAO,8IAAa,CAAC,aAAa,CAAC,uJAAY;IACrD,MAAM,MAAM,MAAM,KAAK,SAAS,CAAC;QAAE;IAAG;IACtC,IAAI,CAAC,KAAK,MAAM,IAAI,MAAM;IAC1B,MAAM,KAAK,MAAM,CAAC;IAClB,OAAO;AACT","debugId":null}},
    {"offset": {"line": 988, "column": 0}, "map": {"version":3,"sources":["file:///Users/varad/Projects/OPSC/src/auth/nextAuthOptions.ts"],"sourcesContent":["import { NextAuthOptions } from 'next-auth';\nimport GoogleProvider from 'next-auth/providers/google';\nimport FacebookProvider from 'next-auth/providers/facebook';\nimport CredentialsProvider from 'next-auth/providers/credentials';\nimport { findUserByEmail } from '../services/userService';\nimport { signup, login } from '../services/authService';\nimport { linkProvider } from '../services/providerService';\n\nexport const authOptions: NextAuthOptions = {\n  providers: [\n    CredentialsProvider({\n      name: 'Credentials',\n      credentials: {\n        email: { label: 'Email', type: 'text' },\n        password: { label: 'Password', type: 'password' },\n      },\n      async authorize(credentials) {\n        if (!credentials) return null;\n        try {\n          const { email, password } = credentials as any;\n          const res = await login(email, password);\n          // login returns { token, user }\n          return res.user as any;\n        } catch (err) {\n          return null;\n        }\n      },\n    }),\n    GoogleProvider({\n      clientId: process.env.GOOGLE_CLIENT_ID || '',\n      clientSecret: process.env.GOOGLE_CLIENT_SECRET || '',\n    }),\n    FacebookProvider({\n      clientId: process.env.FACEBOOK_CLIENT_ID || '',\n      clientSecret: process.env.FACEBOOK_CLIENT_SECRET || '',\n    }),\n  ],\n  secret: process.env.NEXTAUTH_SECRET || process.env.JWT_SECRET || 'dev-nextauth-secret',\n  session: { strategy: 'jwt' },\n  callbacks: {\n    async signIn({ user, account, profile }) {\n      try {\n        // When signing in via OAuth providers, ensure user exists and link provider\n        if (account && account.provider) {\n          let existing = await findUserByEmail(user.email as string);\n          if (!existing) {\n            existing = await signup({ email: user.email as string, accountType: 'client' }) as any;\n          }\n          try {\n            await linkProvider((existing as any).user_id, account.provider, (account as any).providerAccountId, { profile, account });\n          } catch (e) {\n            console.warn('provider link failed:', e);\n          }\n        }\n        return true;\n      } catch (err) {\n        console.error('NextAuth signIn callback error:', err);\n        return false;\n      }\n    },\n    async jwt({ token, user }) {\n      // Attach user id to token for session\n      if (user && (user as any).user_id) {\n        token.sub = (user as any).user_id;\n      }\n      return token;\n    },\n    async session({ session, token }) {\n      (session as any).user = { ...(session as any).user, user_id: token.sub };\n      return session;\n    },\n  },\n};\n\nexport default authOptions;\n"],"names":[],"mappings":";;;;;;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;AAEO,MAAM,cAA+B;IAC1C,WAAW;QACT,IAAA,qKAAmB,EAAC;YAClB,MAAM;YACN,aAAa;gBACX,OAAO;oBAAE,OAAO;oBAAS,MAAM;gBAAO;gBACtC,UAAU;oBAAE,OAAO;oBAAY,MAAM;gBAAW;YAClD;YACA,MAAM,WAAU,WAAW;gBACzB,IAAI,CAAC,aAAa,OAAO;gBACzB,IAAI;oBACF,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG;oBAC5B,MAAM,MAAM,MAAM,IAAA,yIAAK,EAAC,OAAO;oBAC/B,gCAAgC;oBAChC,OAAO,IAAI,IAAI;gBACjB,EAAE,OAAO,KAAK;oBACZ,OAAO;gBACT;YACF;QACF;QACA,IAAA,gKAAc,EAAC;YACb,UAAU,QAAQ,GAAG,CAAC,gBAAgB,IAAI;YAC1C,cAAc,QAAQ,GAAG,CAAC,oBAAoB,IAAI;QACpD;QACA,IAAA,kKAAgB,EAAC;YACf,UAAU,QAAQ,GAAG,CAAC,kBAAkB,IAAI;YAC5C,cAAc,QAAQ,GAAG,CAAC,sBAAsB,IAAI;QACtD;KACD;IACD,QAAQ,QAAQ,GAAG,CAAC,eAAe,IAAI,QAAQ,GAAG,CAAC,UAAU,IAAI;IACjE,SAAS;QAAE,UAAU;IAAM;IAC3B,WAAW;QACT,MAAM,QAAO,EAAE,IAAI,EAAE,OAAO,EAAE,OAAO,EAAE;YACrC,IAAI;gBACF,4EAA4E;gBAC5E,IAAI,WAAW,QAAQ,QAAQ,EAAE;oBAC/B,IAAI,WAAW,MAAM,IAAA,mJAAe,EAAC,KAAK,KAAK;oBAC/C,IAAI,CAAC,UAAU;wBACb,WAAW,MAAM,IAAA,0IAAM,EAAC;4BAAE,OAAO,KAAK,KAAK;4BAAY,aAAa;wBAAS;oBAC/E;oBACA,IAAI;wBACF,MAAM,IAAA,oJAAY,EAAC,AAAC,SAAiB,OAAO,EAAE,QAAQ,QAAQ,EAAE,AAAC,QAAgB,iBAAiB,EAAE;4BAAE;4BAAS;wBAAQ;oBACzH,EAAE,OAAO,GAAG;wBACV,QAAQ,IAAI,CAAC,yBAAyB;oBACxC;gBACF;gBACA,OAAO;YACT,EAAE,OAAO,KAAK;gBACZ,QAAQ,KAAK,CAAC,mCAAmC;gBACjD,OAAO;YACT;QACF;QACA,MAAM,KAAI,EAAE,KAAK,EAAE,IAAI,EAAE;YACvB,sCAAsC;YACtC,IAAI,QAAQ,AAAC,KAAa,OAAO,EAAE;gBACjC,MAAM,GAAG,GAAG,AAAC,KAAa,OAAO;YACnC;YACA,OAAO;QACT;QACA,MAAM,SAAQ,EAAE,OAAO,EAAE,KAAK,EAAE;YAC7B,QAAgB,IAAI,GAAG;gBAAE,GAAG,AAAC,QAAgB,IAAI;gBAAE,SAAS,MAAM,GAAG;YAAC;YACvE,OAAO;QACT;IACF;AACF;uCAEe","debugId":null}},
    {"offset": {"line": 1093, "column": 0}, "map": {"version":3,"sources":["file:///Users/varad/Projects/OPSC/app/api/auth/%5B...nextauth%5D/route.ts"],"sourcesContent":["/**\n * NextAuth route for OAuth sign-in (Google + Facebook).\n *\n * This file uses NextAuth in the App Router (route handler). It implements a\n * signIn callback that finds or creates a user in our application's DB via\n * the existing authService. New OAuth signups default to the `client` role â€”\n * you can later implement an admin approval flow or provider-specific logic.\n */\nimport NextAuth from 'next-auth';\nimport authOptions from '../../../../src/auth/nextAuthOptions';\n\nconst handler = NextAuth(authOptions as any);\n\nexport { handler as GET, handler as POST };\n"],"names":[],"mappings":"AAAA;;;;;;;CAOC;;;;;;AACD;AACA;;;AAEA,MAAM,UAAU,IAAA,kJAAQ,EAAC,2IAAW","debugId":null}}]
}