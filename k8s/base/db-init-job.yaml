apiVersion: batch/v1
kind: Job
metadata:
  name: db-init
  annotations:
    # Hook to run after CockroachDB is ready
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "0"
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-cockroachdb
          image: busybox:1.36
          command: ['sh', '-c', 'until nc -z cockroachdb 26257; do echo waiting for cockroachdb; sleep 2; done']
      containers:
        - name: db-init
          image: gcr.io/PROJECT_ID/bloom-db-init:latest
          env:
            - name: DATABASE_URL
              value: "postgresql://root@cockroachdb:26257/bloom?sslmode=disable"
          command:
            - sh
            - -c
            - |
              echo "Creating database if not exists..."
              npx prisma db push --skip-generate
              echo "Database initialized successfully"
          resources:
            requests:
              cpu: "50m"
              memory: "128Mi"
            limits:
              cpu: "200m"
              memory: "256Mi"
