openapi: 3.0.3
info:
  title: Bloom Health API
  version: 1.0.1
  description: REST API for Bloom Health therapy practice platform
  contact:
    name: Bloom Health
    url: https://bloomhealth.us

servers:
  - url: http://localhost:3000/api
    description: Local development
  - url: https://bloomhealth.us/api
    description: Production
  - url: https://qa.bloomhealth.us/api
    description: QA/Staging

tags:
  - name: Authentication
    description: Better Auth endpoints (catch-all)
  - name: Appointments
    description: Appointment management
  - name: Messages
    description: Conversations and messaging
  - name: User
    description: User profile and settings
  - name: Files
    description: File uploads
  - name: Therapists
    description: Therapist discovery

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: better-auth.session_token
      description: Session cookie set by Better Auth

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          example: "clx1234567890"
        email:
          type: string
          format: email
        firstname:
          type: string
        lastname:
          type: string
        role:
          type: string
          enum: [UNSET, PATIENT, THERAPIST, ADMINISTRATOR]
        image:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time

    Conversation:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        avatar:
          type: string
        avatarColor:
          type: string
        lastMessage:
          type: string
        time:
          type: string
        unread:
          type: integer
        active:
          type: boolean

    Message:
      type: object
      properties:
        id:
          type: string
        sender:
          type: string
        message:
          type: string
        time:
          type: string
        isMe:
          type: boolean
        avatar:
          type: string
        avatarColor:
          type: string
        reactions:
          type: array
          items:
            type: object
            properties:
              emoji:
                type: string
              count:
                type: integer

    Appointment:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
          example: "Appointment"
        start:
          type: string
          format: date-time
        end:
          type: string
          format: date-time
        durationMinutes:
          type: integer
          example: 60
        client:
          type: string
          description: Patient name (for therapists) or therapist name (for patients)
        color:
          type: string
          example: "bg-blue-500"
        zoomLink:
          type: string
          nullable: true
        status:
          type: string
          enum: [SCHEDULED, COMPLETED, CANCELLED, NO_SHOW]
        therapistId:
          type: string
        patientId:
          type: string

    Connection:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        email:
          type: string
          format: email
        image:
          type: string
          nullable: true
        role:
          type: string
          enum: [PATIENT, THERAPIST]

    Therapist:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        email:
          type: string
        image:
          type: string
          nullable: true
        role:
          type: string
          example: THERAPIST

    UploadResponse:
      type: object
      properties:
        url:
          type: string
        pathname:
          type: string

    Settings:
      type: object
      properties:
        user:
          type: object
          properties:
            firstname: { type: string }
            lastname: { type: string }
            email: { type: string }
            bio: { type: string, nullable: true }
            image: { type: string, nullable: true }
        accounts:
          type: array
          items:
            type: object
            properties:
              providerId:
                type: string
        allowPasswordChange:
          type: boolean

    Error:
      type: object
      properties:
        error:
          type: string

    Success:
      type: object
      properties:
        success:
          type: boolean

security:
  - cookieAuth: []

paths:
  /auth/{path}:
    get:
      tags: [Authentication]
      summary: Better Auth endpoints (catch-all)
      description: Handles session management, OAuth callbacks, email verification
      security: []
      parameters:
        - name: path
          in: path
          required: true
          schema:
            type: string
          description: Auth endpoint path (e.g., session, callback/google)
      responses:
        '200':
          description: Success
    post:
      tags: [Authentication]
      summary: Better Auth endpoints (catch-all)
      description: |
        Handles authentication operations:
        - `sign-up/email` - Register with email/password
        - `sign-in/email` - Login with email/password
        - `sign-in/social` - OAuth login (Google, Zoom)
        - `sign-out` - Logout
        - `forget-password` - Request password reset
        - `reset-password` - Reset password with token
        - `verify-email` - Verify email address
        - `two-factor/*` - 2FA operations
      security: []
      parameters:
        - name: path
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              description: Request body varies by endpoint
      responses:
        '200':
          description: Success

  /appointments:
    get:
      tags: [Appointments]
      summary: Get weekly appointments
      description: |
        Returns appointments for the current week (Monday to Sunday).
        - Therapists see appointments where they are the therapist
        - Patients see appointments where they are the patient
      responses:
        '200':
          description: List of appointments
          content:
            application/json:
              schema:
                type: object
                properties:
                  appointments:
                    type: array
                    items:
                      $ref: '#/components/schemas/Appointment'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      tags: [Appointments]
      summary: Create appointment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [startAt, endAt, participantId]
              properties:
                startAt:
                  type: string
                  format: date-time
                endAt:
                  type: string
                  format: date-time
                participantId:
                  type: string
                  description: Other participant (patient or therapist depending on caller role)
      responses:
        '200':
          description: Appointment created
          content:
            application/json:
              schema:
                type: object
                properties:
                  appointmentId:
                    type: string
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Participant not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    patch:
      tags: [Appointments]
      summary: Update appointment time (therapist only)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [appointmentId, startAt, endAt]
              properties:
                appointmentId: { type: string }
                startAt: { type: string, format: date-time }
                endAt: { type: string, format: date-time }
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Success'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Only therapist may edit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Appointment not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      tags: [Appointments]
      summary: Cancel appointment (patient only)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [appointmentId]
              properties:
                appointmentId: { type: string }
      responses:
        '200':
          description: Cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Success'
        '403':
          description: Only patient may cancel
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Appointment not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /messages:
    get:
      tags: [Messages]
      summary: Get conversations and messages
      parameters:
        - name: conversationId
          in: query
          schema:
            type: string
          description: Optional conversation id to focus
      responses:
        '200':
          description: Conversations and messages
          content:
            application/json:
              schema:
                type: object
                properties:
                  conversations:
                    type: array
                    items:
                      $ref: '#/components/schemas/Conversation'
                  messages:
                    type: array
                    items:
                      $ref: '#/components/schemas/Message'
        '401':
          description: Unauthorized
    post:
      tags: [Messages]
      summary: Send a message or start a conversation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                conversationId:
                  type: string
                  description: Existing conversation id
                recipientId:
                  type: string
                  description: Target user id (used when no conversation exists)
                message:
                  type: string
                  description: Message content (required unless startOnly = true)
                startOnly:
                  type: boolean
                  description: When true, ensure conversation exists without sending a message
      responses:
        '200':
          description: Message sent or conversation created
          content:
            application/json:
              schema:
                type: object
                properties:
                  conversation:
                    $ref: '#/components/schemas/Conversation'
                  message:
                    $ref: '#/components/schemas/Message'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Not a participant in the conversation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Recipient or conversation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /therapists/available:
    get:
      tags: [Therapists]
      summary: List available therapists
      description: Returns therapists (role=THERAPIST) excluding the requester.
      responses:
        '200':
          description: Therapist list
          content:
            application/json:
              schema:
                type: object
                properties:
                  therapists:
                    type: array
                    items:
                      $ref: '#/components/schemas/Therapist'
        '401':
          description: Unauthorized

  /upload:
    post:
      tags: [Files]
      summary: Upload a file to blob storage
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: Upload success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'
        '400':
          description: No file provided
        '401':
          description: Unauthorized
        '500':
          description: Upload misconfigured or failed

  /user/{userId}:
    get:
      tags: [User]
      summary: Get user by ID
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
        '404':
          description: User not found

  /user/connections:
    get:
      tags: [User]
      summary: Get connected users
      description: |
        Returns users connected to the current user based on their role:
        - For therapists: their patients
        - For patients: their therapists
      responses:
        '200':
          description: List of connections
          content:
            application/json:
              schema:
                type: object
                properties:
                  people:
                    type: array
                    items:
                      $ref: '#/components/schemas/Connection'
        '401':
          description: Unauthorized

  /user/profile:
    patch:
      tags: [User]
      summary: Update user profile (basic)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                firstname: { type: string }
                lastname: { type: string }
                bio: { type: string }
      responses:
        '200':
          description: Profile updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  user:
                    type: object
                    properties:
                      firstname: { type: string }
                      lastname: { type: string }
        '401':
          description: Unauthorized
        '500':
          description: Update failed

  /user/settings:
    get:
      tags: [User]
      summary: Get user settings
      responses:
        '200':
          description: Settings payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Settings'
        '401':
          description: Unauthorized
    patch:
      tags: [User]
      summary: Update user settings
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                firstname: { type: string }
                lastname: { type: string }
                bio: { type: string }
                image: { type: string }
      responses:
        '200':
          description: Settings updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  user:
                    type: object
                    properties:
                      firstname: { type: string }
                      lastname: { type: string }
                      bio: { type: string }
                      image: { type: string }
        '400':
          description: No fields provided
        '401':
          description: Unauthorized
        '500':
          description: Update failed

  /user/password:
    post:
      tags: [User]
      summary: Change password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [currentPassword, newPassword]
              properties:
                currentPassword: { type: string }
                newPassword: { type: string, minLength: 8 }
      responses:
        '200':
          description: Password changed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Success'
        '400':
          description: Validation error
        '401':
          description: Unauthorized
        '500':
          description: Failed to change password

  /user/role:
    post:
      tags: [User]
      summary: Set user role
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [role]
              properties:
                role:
                  type: string
                  enum: [practitioner, patient]
      responses:
        '200':
          description: Role updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  role: { type: string }
        '400':
          description: Invalid role
        '401':
          description: Unauthorized
        '500':
          description: Update failed
